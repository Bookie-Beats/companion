{"version":3,"file":"settings.js","sources":["../src/lib/settings.ts"],"sourcesContent":["import browser from \"./browser.js\";\n\n// Default settings for all supported sites\nexport const DEFAULT_SETTINGS = {\n  \"global.extensionEnabled\": true,\n  \"kalshi.extensionEnabled\": true,\n  \"kalshi.oddsDisplayMode\": \"american\",\n  \"kalshi.hideCharts\": true,\n  \"kalshi.feeDisplayMode\": \"taker\",\n  \"kalshi.customFeeRate\": 0.07,\n  \"debug.enabled\": false,\n} as const;\n\n// Settings keys organized by site\nexport const SITE_SETTINGS = {\n  global: [\"global.extensionEnabled\", \"debug.enabled\"],\n  kalshi: [\n    \"kalshi.extensionEnabled\",\n    \"kalshi.oddsDisplayMode\",\n    \"kalshi.hideCharts\",\n    \"kalshi.feeDisplayMode\",\n    \"kalshi.customFeeRate\",\n  ],\n} as const;\n\n// Supported sites for URL detection\nexport const SUPPORTED_SITES = {\n  kalshi: /(^|\\.)kalshi\\.com$/i,\n} as const;\n\nexport type SiteName = keyof typeof SUPPORTED_SITES;\nexport type DisplayMode = \"american\" | \"price\" | \"both\";\nexport type FeeDisplayMode = \"taker\" | \"maker\" | \"raw\" | \"custom\";\n\n/**\n * Detect which supported site the current tab is on\n */\nexport async function detectCurrentSite(): Promise<SiteName | null> {\n  try {\n    const tabs = await browser.tabs.query({\n      active: true,\n      currentWindow: true,\n    });\n    const currentTab = tabs[0];\n\n    if (currentTab?.url) {\n      const url = new URL(currentTab.url);\n\n      for (const [siteName, pattern] of Object.entries(SUPPORTED_SITES)) {\n        if (pattern.test(url.hostname)) {\n          return siteName as SiteName;\n        }\n      }\n    }\n  } catch (error) {\n    console.warn(\"Could not detect current site:\", error);\n  }\n\n  return null;\n}\n\n/**\n * Load settings for a specific site or global settings\n */\nexport async function loadSiteSettings(\n  site: SiteName | null = null\n): Promise<Record<string, any>> {\n  try {\n    const keys = site\n      ? SITE_SETTINGS[site]\n      : Object.values(SITE_SETTINGS).flat();\n    const settings = await browser.storage.local.get(keys);\n\n    // Apply defaults for missing values\n    for (const key of keys) {\n      if (settings[key] === undefined && key in DEFAULT_SETTINGS) {\n        settings[key] = DEFAULT_SETTINGS[key as keyof typeof DEFAULT_SETTINGS];\n      }\n    }\n\n    return settings;\n  } catch (error) {\n    console.error(\"Failed to load settings:\", error);\n    return {};\n  }\n}\n\n/**\n * Load all settings from storage\n */\nexport async function loadAllSettings(): Promise<Record<string, any>> {\n  try {\n    const allKeys = Object.values(SITE_SETTINGS).flat();\n    const settings = await browser.storage.local.get(allKeys);\n\n    // Apply defaults for missing values\n    for (const [key, defaultValue] of Object.entries(DEFAULT_SETTINGS)) {\n      if (settings[key] === undefined) {\n        settings[key] = defaultValue;\n      }\n    }\n\n    return settings;\n  } catch (error) {\n    console.error(\"Failed to load all settings:\", error);\n    return DEFAULT_SETTINGS;\n  }\n}\n\n/**\n * Save a single setting\n */\nexport async function saveSetting(key: string, value: any): Promise<void> {\n  try {\n    await browser.storage.local.set({ [key]: value });\n    // Only log in debug mode\n    const settings = await browser.storage.local.get([\"debug.enabled\"]);\n    if (settings[\"debug.enabled\"]) {\n      console.log(`Saved setting: ${key} = ${value}`);\n    }\n  } catch (error) {\n    console.error(`Failed to save setting ${key}:`, error);\n    throw error;\n  }\n}\n\n/**\n * Save multiple settings at once\n */\nexport async function saveSettings(\n  settings: Record<string, any>\n): Promise<void> {\n  try {\n    await browser.storage.local.set(settings);\n    // Only log in debug mode\n    const debugSettings = await browser.storage.local.get([\"debug.enabled\"]);\n    if (debugSettings[\"debug.enabled\"]) {\n      console.log(\"Saved settings:\", settings);\n    }\n  } catch (error) {\n    console.error(\"Failed to save settings:\", error);\n    throw error;\n  }\n}\n\n/**\n * Reset all settings to defaults\n */\nexport async function resetAllSettings(): Promise<void> {\n  try {\n    await browser.storage.local.clear();\n    await browser.storage.local.set(DEFAULT_SETTINGS);\n    // Only log in debug mode\n    const debugSettings = await browser.storage.local.get([\"debug.enabled\"]);\n    if (debugSettings[\"debug.enabled\"]) {\n      console.log(\"Reset all settings to defaults\");\n    }\n  } catch (error) {\n    console.error(\"Failed to reset settings:\", error);\n    throw error;\n  }\n}\n\n/**\n * Get setting key for a specific site and setting type\n */\nexport function getSettingKey(\n  site: SiteName | null,\n  settingType: string\n): string {\n  return site ? `${site}.${settingType}` : `global.${settingType}`;\n}\n\n/**\n * Notify content scripts about setting changes\n */\nexport async function notifyContentScripts(message: any): Promise<void> {\n  try {\n    const tabs = await browser.tabs.query({});\n\n    for (const tab of tabs) {\n      if (tab.id && tab.url) {\n        const url = new URL(tab.url);\n\n        // Check if this tab is on a supported site\n        for (const [siteName, pattern] of Object.entries(SUPPORTED_SITES)) {\n          if (pattern.test(url.hostname)) {\n            try {\n              await browser.tabs.sendMessage(tab.id, message);\n              break; // Only send once per tab\n            } catch (error) {\n              // Tab might not have content script loaded, ignore\n            }\n          }\n        }\n      }\n    }\n  } catch (error) {\n    console.error(\"Failed to notify content scripts:\", error);\n  }\n}\n\n/**\n * Create a settings manager for a specific context (popup or options page)\n */\nexport class SettingsManager {\n  private site: SiteName | null = null;\n\n  constructor(site: SiteName | null = null) {\n    this.site = site;\n  }\n\n  async init(): Promise<void> {\n    if (this.site === null) {\n      this.site = await detectCurrentSite();\n    }\n  }\n\n  getCurrentSite(): SiteName | null {\n    return this.site;\n  }\n\n  async loadSettings(): Promise<Record<string, any>> {\n    return this.site ? loadSiteSettings(this.site) : loadAllSettings();\n  }\n\n  async saveSetting(settingType: string, value: any): Promise<void> {\n    const key = getSettingKey(this.site, settingType);\n    await saveSetting(key, value);\n  }\n\n  async notifyChange(message: any): Promise<void> {\n    await notifyContentScripts(message);\n  }\n}\n"],"names":[],"mappings":"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"}